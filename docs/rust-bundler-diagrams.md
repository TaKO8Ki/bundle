# Rust Ruby Bundler - Detailed Component Diagrams

## Table of Contents
1. [System Architecture Overview](#system-architecture-overview)
2. [Dependency Provider Architecture](#dependency-provider-architecture)
3. [Resolution Flow](#resolution-flow)
4. [Installation Flow](#installation-flow)
5. [Shared State Management](#shared-state-management)
6. [Trait Hierarchy](#trait-hierarchy)
7. [Caching Architecture](#caching-architecture)
8. [Error Handling Flow](#error-handling-flow)
9. [Concurrency Model](#concurrency-model)

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 Bundler                                         │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │    Resolver     │  │    Installer    │  │     Config      │                │
│  │                 │  │                 │  │                 │                │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │                │
│  │ │  PubGrub    │ │  │ │  Download   │ │  │ │  Sources    │ │                │
│  │ │  Strategy   │ │  │ │  Manager    │ │  │ │  Config     │ │                │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │                │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │                │
│  │ │  Molinillo  │ │  │ │    Build    │ │  │ │  Platform   │ │                │
│  │ │  Strategy   │ │  │ │   System    │ │  │ │   Config    │ │                │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
│           │                     │                     │                        │
│           └─────────────────────┼─────────────────────┘                        │
│                                 │                                              │
│  ┌──────────────────────────────▼───────────────────────────────────────────┐  │
│  │                         BundlerContext (Arc)                             │  │
│  │                                                                          │  │
│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │  │
│  │  │    Sources      │ │      Cache      │ │    Platform     │           │  │
│  │  │                 │ │   (RwLock)      │ │    Detection    │           │  │
│  │  │ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │           │  │
│  │  │ │   Remote    │ │ │ │    Specs    │ │ │ │    Ruby     │ │           │  │
│  │  │ │   Source    │ │ │ │    Cache    │ │ │ │   Version   │ │           │  │
│  │  │ └─────────────┘ │ │ └─────────────┘ │ │ └─────────────┘ │           │  │
│  │  │ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │           │  │
│  │  │ │    Local    │ │ │ │  Download   │ │ │ │    OS       │ │           │  │
│  │  │ │   Source    │ │ │ │    Cache    │ │ │ │   Details   │ │           │  │
│  │  │ └─────────────┘ │ │ └─────────────┘ │ │ └─────────────┘ │           │  │
│  │  │ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │           │  │
│  │  │ │     Git     │ │ │ │  Metadata   │ │ │ │Architecture │ │           │  │
│  │  │ │   Source    │ │ │ │    Cache    │ │ │ │   Details   │ │           │  │
│  │  │ └─────────────┘ │ │ └─────────────┘ │ │ └─────────────┘ │           │  │
│  │  └─────────────────┘ └─────────────────┘ └─────────────────┘           │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Dependency Provider Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           DependencyProvider Trait                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  + search_for(dependency: &Dependency) -> Vec<Box<dyn Specification>>   │   │
│  │  + name_for(specification: &dyn Specification) -> String                │   │
│  │  + dependencies_for(specification: &dyn Specification) -> Vec<Dependency│   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────┬───────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
    ┌─────────▼─────────┐ ┌───▼───────────┐ ┌─▼───────────────┐
    │   RemoteProvider  │ │ LocalProvider │ │   GitProvider   │
    │                   │ │               │ │                 │
    │ ┌───────────────┐ │ │ ┌───────────┐ │ │ ┌─────────────┐ │
    │ │   RubyGems    │ │ │ │   Local   │ │ │ │    Git      │ │
    │ │   API Client  │ │ │ │   Gems    │ │ │ │  Repository │ │
    │ └───────────────┘ │ │ │  Scanner  │ │ │ │   Parser    │ │
    │ ┌───────────────┐ │ │ └───────────┘ │ │ └─────────────┘ │
    │ │   HTTP        │ │ │ ┌───────────┐ │ │ ┌─────────────┐ │
    │ │   Client      │ │ │ │   Path    │ │ │ │   Ref       │ │
    │ └───────────────┘ │ │ │  Resolver │ │ │ │  Resolver   │ │
    │ ┌───────────────┐ │ │ └───────────┘ │ │ └─────────────┘ │
    │ │   Response    │ │ │               │ │                 │
    │ │   Parser      │ │ │               │ │                 │ 
    │ └───────────────┘ │ │               │ │                 │
    └───────────────────┘ └───────────────┘ └─────────────────┘
              │                     │                 │
              └─────────────────────┼─────────────────┘
                                    │
            ┌───────────────────────▼───────────────────────┐
            │          CompositeDependencyProvider          │
            │                                               │
            │  ┌─────────────────────────────────────────┐  │
            │  │           Provider Priority             │  │
            │  │                                         │  │
            │  │  1. Local Provider (highest)           │  │
            │  │  2. Git Provider                       │  │
            │  │  3. Remote Provider (lowest)           │  │
            │  └─────────────────────────────────────────┘  │
            │                                               │
            │  ┌─────────────────────────────────────────┐  │
            │  │          Caching Strategy               │  │
            │  │                                         │  │
            │  │  - Cache results from each provider     │  │
            │  │  - Invalidate based on source changes   │  │
            │  │  - Merge results with priority order    │  │
            │  └─────────────────────────────────────────┘  │
            └───────────────────────────────────────────────┘
```

## Resolution Flow

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Gemfile       │    │  Gemfile.lock   │    │   CLI Args      │
│                 │    │                 │    │                 │
│ source 'https://│    │ GEM             │    │ --update foo    │
│ rubygems.org'   │    │   remote: https:│    │ --conservative  │
│                 │    │   specs:        │    │                 │
│ gem 'rails'     │    │     rails (7.0) │    │                 │
│ gem 'pg'        │    │     pg (1.4.0)  │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                                 ▼
                 ┌─────────────────────────────┐
                 │      Requirements           │
                 │      Generation             │
                 │                             │
                 │ ┌─────────────────────────┐ │
                 │ │  Parse Gemfile          │ │
                 │ │  Parse existing lock    │ │
                 │ │  Apply CLI constraints  │ │
                 │ └─────────────────────────┘ │
                 └─────────────┬───────────────┘
                               │
                               ▼
                 ┌─────────────────────────────┐
                 │        Resolver             │
                 │                             │
                 │ ┌─────────────────────────┐ │    ┌─────────────────────────┐
                 │ │   Strategy Selection    │ │    │   Dependency Provider   │
                 │ │                         │ │    │                         │
                 │ │  if has_conflicts():    │ │    │ ┌─────────────────────┐ │
                 │ │    PubGrubStrategy      │ │◀───┤ │   Source Priority   │ │
                 │ │  else:                  │ │    │ │                     │ │
                 │ │    MolinilloStrategy    │ │    │ │ 1. Local gems       │ │
                 │ └─────────────────────────┘ │    │ │ 2. Git repos        │ │
                 │                             │    │ │ 3. Remote registry  │ │
                 │ ┌─────────────────────────┐ │    │ └─────────────────────┘ │
                 │ │   Resolution Process    │ │    │                         │
                 │ │                         │ │    │ ┌─────────────────────┐ │
                 │ │ 1. Build dependency     │ │    │ │   Caching Layer     │ │
                 │ │    graph                │ │    │ │                     │ │
                 │ │ 2. Find candidates      │ │    │ │ - Spec metadata     │ │
                 │ │ 3. Check constraints    │ │    │ │ - Version lists     │ │
                 │ │ 4. Resolve conflicts    │ │    │ │ - Dependency info   │ │
                 │ │ 5. Validate solution    │ │    │ └─────────────────────┘ │
                 │ └─────────────────────────┘ │    └─────────────────────────┘
                 └─────────────┬───────────────┘
                               │
                               ▼
                 ┌─────────────────────────────┐
                 │    Resolution Result        │
                 │                             │
                 │ ┌─────────────────────────┐ │
                 │ │  Selected Gems          │ │
                 │ │                         │ │
                 │ │  rails (7.0.4)         │ │
                 │ │  pg (1.4.3)            │ │
                 │ │  rack (2.2.4)          │ │
                 │ │  ... (dependencies)     │ │
                 │ └─────────────────────────┘ │
                 │                             │
                 │ ┌─────────────────────────┐ │
                 │ │  Platform Info          │ │
                 │ │  Source Mapping         │ │
                 │ │  Constraint Reasons     │ │
                 │ └─────────────────────────┘ │
                 └─────────────────────────────┘
```

## Installation Flow

```
┌─────────────────────────────┐
│    Resolution Result        │
│  (Selected Specifications)  │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│       Installer             │
│                             │
│ ┌─────────────────────────┐ │
│ │    Install Planning     │ │
│ │                         │ │
│ │ 1. Dependency ordering  │ │
│ │ 2. Source verification  │ │
│ │ 3. Platform filtering   │ │
│ │ 4. Conflict detection   │ │
│ └─────────────────────────┘ │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│      Install Plan           │
│    (Ordered Dependencies)   │
│                             │
│ ┌─────────────────────────┐ │
│ │     Phase 1: Base       │ │
│ │   ┌─────────────────┐   │ │
│ │   │ bundler         │   │ │
│ │   │ rake            │   │ │
│ │   └─────────────────┘   │ │
│ └─────────────────────────┘ │
│                             │
│ ┌─────────────────────────┐ │
│ │   Phase 2: Dependencies │ │
│ │   ┌─────────────────┐   │ │
│ │   │ rack            │   │ │
│ │   │ nokogiri        │   │ │
│ │   └─────────────────┘   │ │
│ └─────────────────────────┘ │
│                             │
│ ┌─────────────────────────┐ │
│ │   Phase 3: Applications │ │
│ │   ┌─────────────────┐   │ │
│ │   │ rails           │   │ │
│ │   │ pg              │   │ │
│ │   └─────────────────┘   │ │
│ └─────────────────────────┘ │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│     Parallel Execution      │
│                             │
│ ┌─────────────────────────┐ │    ┌─────────────────────────┐
│ │   Download Manager      │ │    │    Build System         │
│ │                         │ │    │                         │
│ │ ┌─────────────────────┐ │ │    │ ┌─────────────────────┐ │
│ │ │  HTTP Downloads     │ │ │    │ │   Extension Types   │ │
│ │ │                     │ │ │    │ │                     │ │
│ │ │ - Concurrent fetches│ │ │    │ │ - C Extensions      │ │
│ │ │ - Checksum verify   │ │ │    │ │ - Rust Extensions   │ │
│ │ │ - Retry logic       │ │ │    │ │ - FFI bindings      │ │
│ │ └─────────────────────┘ │ │    │ └─────────────────────┘ │
│ │                         │ │    │                         │
│ │ ┌─────────────────────┐ │ │    │ ┌─────────────────────┐ │
│ │ │  Git Clones         │ │ │    │ │   Build Process     │ │
│ │ │                     │ │ │    │ │                     │ │
│ │ │ - Shallow clones    │ │ │    │ │ - Dependency order  │ │
│ │ │ - Ref resolution    │ │ │    │ │ - Parallel builds   │ │
│ │ │ - Submodule support │ │ │    │ │ - Error recovery    │ │
│ │ └─────────────────────┘ │ │    │ └─────────────────────┘ │
│ └─────────────────────────┘ │    └─────────────────────────┘
└─────────────┬───────────────┘              │
              │                              │
              └──────────────┬───────────────┘
                             │
                             ▼
                 ┌─────────────────────────────┐
                 │     Deploy Manager          │
                 │                             │
                 │ ┌─────────────────────────┐ │
                 │ │   File Operations       │ │
                 │ │                         │ │
                 │ │ - Gem installation      │ │
                 │ │ - Binary generation     │ │
                 │ │ - Documentation         │ │
                 │ │ - Cache updates         │ │
                 │ └─────────────────────────┘ │
                 │                             │
                 │ ┌─────────────────────────┐ │
                 │ │   Lock File Updates     │ │
                 │ │                         │ │
                 │ │ - Generate new lock     │ │
                 │ │ - Preserve comments     │ │
                 │ │ - Platform specifics    │ │
                 │ └─────────────────────────┘ │
                 └─────────────────────────────┘
```

## Shared State Management

```
                    ┌─────────────────────────────────────────┐
                    │           BundlerContext                │
                    │              (Arc<T>)                   │
                    │                                         │
                    │  ┌─────────────────────────────────┐    │
                    │  │          Configuration          │    │
                    │  │                                 │    │
                    │  │ - Source URLs                   │    │
                    │  │ - Platform settings             │    │
                    │  │ - Cache directories             │    │
                    │  │ - Authentication tokens         │    │
                    │  └─────────────────────────────────┘    │
                    └─────────────────┬───────────────────────┘
                                      │
          ┌───────────────────────────┼───────────────────────────┐
          │                           │                           │
    ┌─────▼─────┐               ┌─────▼─────┐               ┌─────▼─────┐
    │ Resolver  │               │   Cache   │               │ Installer │
    │           │               │ (RwLock)  │               │           │
    │ ┌───────┐ │               │           │               │ ┌───────┐ │
    │ │ Read  │ │◀──────────────┤ ┌───────┐ ├──────────────▶│ │ Read  │ │
    │ │ Specs │ │               │ │ Spec  │ │               │ │ Specs │ │
    │ └───────┘ │               │ │ Cache │ │               │ └───────┘ │
    │           │               │ └───────┘ │               │           │
    │ ┌───────┐ │               │           │               │ ┌───────┐ │
    │ │ Cache │ │──────────────▶│ ┌───────┐ │◀──────────────│ │ Store │ │
    │ │Results│ │               │ │ Down  │ │               │ │ Files │ │
    │ └───────┘ │               │ │ Cache │ │               │ └───────┘ │
    │           │               │ └───────┘ │               │           │
    │ ┌───────┐ │               │           │               │ ┌───────┐ │
    │ │ Query │ │──────────────▶│ ┌───────┐ │◀──────────────│ │ Query │ │
    │ │Sources│ │               │ │ Meta  │ │               │ │Sources│ │
    │ └───────┘ │               │ │ Cache │ │               │ └───────┘ │
    └───────────┘               │ └───────┘ │               └───────────┘
                                └───────────┘
                                      │
                                      ▼
                            ┌─────────────────┐
                            │  Cache Storage  │
                            │                 │
                            │ ┌─────────────┐ │
                            │ │   Memory    │ │
                            │ │   Layer     │ │
                            │ └─────────────┘ │
                            │ ┌─────────────┐ │
                            │ │   Disk      │ │
                            │ │   Layer     │ │
                            │ └─────────────┘ │
                            │ ┌─────────────┐ │
                            │ │  Network    │ │
                            │ │   Layer     │ │
                            │ └─────────────┘ │
                            └─────────────────┘
```

## Trait Hierarchy

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                Core Traits                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│ ┌─────────────────────────────┐    ┌─────────────────────────────────────────┐ │
│ │        Specification        │    │           DependencyProvider           │ │
│ │                             │    │                                         │ │
│ │  + name() -> &str           │    │  + search_for(&Dependency)             │ │
│ │  + version() -> &Version    │    │      -> Vec<Box<dyn Specification>>    │ │
│ │  + dependencies()           │    │  + dependencies_for(&dyn Specification)│ │
│ │      -> &[Dependency]       │    │      -> Vec<Dependency>                │ │
│ │  + platform_compatible()    │    │  + name_for(&dyn Specification)        │ │
│ │      -> bool                │    │      -> String                         │ │
│ └─────────────────────────────┘    └─────────────────────────────────────────┘ │
│               ▲                                           ▲                    │
│               │                                           │                    │
│    ┌──────────┴──────────┐                   ┌───────────┴────────────┐       │
│    │                     │                   │                        │       │
│ ┌──▼──────────┐ ┌────────▼────────┐ ┌────────▼───────┐ ┌──────────────▼─────┐ │
│ │GemSpecifica-│ │ LocalSpecifica- │ │ RemoteProvider │ │CompositeDependency │ │
│ │tion         │ │tion             │ │                │ │Provider            │ │
│ │             │ │                 │ │ ┌────────────┐ │ │                    │ │
│ │ ┌─────────┐ │ │ ┌─────────────┐ │ │ │ HTTP       │ │ │ ┌────────────────┐ │ │
│ │ │ Gem     │ │ │ │ Path        │ │ │ │ Client     │ │ │ │ Provider List  │ │ │
│ │ │ Metadata│ │ │ │ Resolution  │ │ │ └────────────┘ │ │ │ with Priority  │ │ │
│ │ └─────────┘ │ │ └─────────────┘ │ │ ┌────────────┐ │ │ └────────────────┘ │ │
│ │ ┌─────────┐ │ │ ┌─────────────┐ │ │ │ Response   │ │ │ ┌────────────────┐ │ │
│ │ │ Version │ │ │ │ File        │ │ │ │ Parsing    │ │ │ │ Result         │ │ │
│ │ │ Parsing │ │ │ │ Scanning    │ │ │ └────────────┘ │ │ │ Aggregation    │ │ │
│ │ └─────────┘ │ │ └─────────────┘ │ └────────────────┘ │ └────────────────┘ │ │
│ └─────────────┘ └─────────────────┘                    └────────────────────┘ │
│                                                                                 │
│ ┌─────────────────────────────┐    ┌─────────────────────────────────────────┐ │
│ │    SpecificationSource      │    │         ResolverStrategy                │ │
│ │                             │    │                                         │ │
│ │  + fetch_specs(&Dependency) │    │  + resolve(&[Dependency],               │ │
│ │      -> Result<Vec<Info>>   │    │            &dyn DependencyProvider)     │ │
│ │  + supports_remote() -> bool│    │      -> Result<ResolutionResult>       │ │
│ └─────────────────────────────┘    └─────────────────────────────────────────┘ │
│               ▲                                           ▲                    │
│               │                                           │                    │
│    ┌──────────┴──────────┐                   ┌───────────┴────────────┐       │
│    │                     │                   │                        │       │
│ ┌──▼──────────┐ ┌────────▼────────┐ ┌────────▼───────┐ ┌──────────────▼─────┐ │
│ │ RemoteSource│ │   LocalSource   │ │ PubGrubStrategy│ │ MolinilloStrategy  │ │
│ │             │ │                 │ │                │ │                    │ │
│ │ ┌─────────┐ │ │ ┌─────────────┐ │ │ ┌────────────┐ │ │ ┌────────────────┐ │ │
│ │ │ API     │ │ │ │ Directory   │ │ │ │ Conflict   │ │ │ │ Version        │ │ │
│ │ │ Client  │ │ │ │ Scanner     │ │ │ │ Resolution │ │ │ │ Selection      │ │ │
│ │ └─────────┘ │ │ └─────────────┘ │ │ └────────────┘ │ │ └────────────────┘ │ │
│ │ ┌─────────┐ │ │ ┌─────────────┐ │ │ ┌────────────┐ │ │ ┌────────────────┐ │ │
│ │ │ Caching │ │ │ │ Gem         │ │ │ │ Backtrack  │ │ │ │ Dependency     │ │ │
│ │ │ Logic   │ │ │ │ Validation  │ │ │ │ Algorithm  │ │ │ │ Graph Build    │ │ │
│ │ └─────────┘ │ │ └─────────────┘ │ │ └────────────┘ │ │ └────────────────┘ │ │
│ └─────────────┘ └─────────────────┘ └────────────────┘ └────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Caching Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Caching System                                      │
│                                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                        SpecificationCache                                  │ │
│ │                             (RwLock)                                       │ │
│ │                                                                             │ │
│ │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│ │  │   Memory Cache  │  │   Disk Cache    │  │      Network Cache          │ │ │
│ │  │                 │  │                 │  │                             │ │ │
│ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────────────────┐ │ │ │
│ │  │ │    LRU      │ │  │ │    SQLite   │ │  │ │      HTTP Cache         │ │ │ │
│ │  │ │   HashMap   │ │  │ │   Database  │ │  │ │                         │ │ │ │
│ │  │ └─────────────┘ │  │ └─────────────┘ │  │ │ - ETags                 │ │ │ │
│ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ │ - Last-Modified         │ │ │ │
│ │  │ │  Hot Specs  │ │  │ │    Spec     │ │  │ │ - Cache-Control         │ │ │ │
│ │  │ │  (Recent)   │ │  │ │   Metadata  │ │  │ └─────────────────────────┘ │ │ │
│ │  │ └─────────────┘ │  │ └─────────────┘ │  │ ┌─────────────────────────┐ │ │ │
│ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ │    Response Caching     │ │ │ │
│ │  │ │ Dependency  │ │  │ │  Download   │ │  │ │                         │ │ │ │
│ │  │ │    Graph    │ │  │ │   Blobs     │ │  │ │ - JSON responses        │ │ │ │
│ │  │ └─────────────┘ │  │ └─────────────┘ │  │ │ - Compressed data       │ │ │ │
│ │  └─────────────────┘  └─────────────────┘  │ │ - Partial responses     │ │ │ │
│ │                                             │ └─────────────────────────┘ │ │ │
│ │                                             └─────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│                                    ▲                                           │
│                                    │                                           │
│        ┌───────────────────────────┼───────────────────────────┐               │
│        │                           │                           │               │
│  ┌─────▼─────┐                ┌────▼────┐                ┌─────▼─────┐         │
│  │ Resolver  │                │ Shared  │                │ Installer │         │
│  │           │                │ Access  │                │           │         │
│  │ ┌───────┐ │                │ Layer   │                │ ┌───────┐ │         │
│  │ │ Read  │ │────────────────┤         ├────────────────│ │ Read  │ │         │
│  │ │ Specs │ │                │ ┌─────┐ │                │ │ Specs │ │         │
│  │ └───────┘ │                │ │Cache│ │                │ └───────┘ │         │
│  │ ┌───────┐ │                │ │ API │ │                │ ┌───────┐ │         │
│  │ │ Write │ │────────────────┤ └─────┘ ├────────────────│ │ Write │ │         │
│  │ │Results│ │                │         │                │ │ Files │ │         │
│  │ └───────┘ │                │ ┌─────┐ │                │ └───────┘ │         │
│  └───────────┘                │ │Sync │ │                └───────────┘         │
│                                │ │Logic│ │                                      │
│                                │ └─────┘ │                                      │
│                                └─────────┘                                      │
│                                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                         Cache Invalidation                                  │ │
│ │                                                                             │ │
│ │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│ │  │  Time-based     │  │  Event-based    │  │      Content-based          │ │ │
│ │  │                 │  │                 │  │                             │ │ │
│ │  │ - TTL for specs │  │ - Gemfile       │  │ - Checksum validation       │ │ │
│ │  │ - Periodic      │  │   changes       │  │ - Version comparison        │ │ │
│ │  │   cleanup       │  │ - Source        │  │ - Dependency changes        │ │ │
│ │  │ - LRU eviction  │  │   updates       │  │                             │ │ │
│ │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Error Handling Architecture                           │
│                                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                              BundlerError                                  │ │
│ │                              (Error Enum)                                  │ │
│ │                                                                             │ │
│ │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│ │  │ ResolutionError │  │InstallationError│  │      NetworkError          │ │ │
│ │  │                 │  │                 │  │                             │ │ │
│ │  │ - Conflicts     │  │ - Build fails   │  │ - Connection timeout       │ │ │
│ │  │ - Missing deps  │  │ - File perms    │  │ - DNS resolution           │ │ │
│ │  │ - Version       │  │ - Disk space    │  │ - HTTP errors             │ │ │
│ │  │   constraints   │  │ - Dependencies  │  │ - SSL/TLS issues          │ │ │
│ │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │ │
│ │                                                                             │ │
│ │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│ │  │   ParsingError  │  │   ConfigError   │  │        IOError             │ │ │
│ │  │                 │  │                 │  │                             │ │ │
│ │  │ - Gemfile       │  │ - Invalid       │  │ - File not found           │ │ │
│ │  │   syntax        │  │   settings      │  │ - Permission denied        │ │ │
│ │  │ - Version       │  │ - Missing       │  │ - Disk full               │ │ │
│ │  │   parsing       │  │   config        │  │ - Path issues             │ │ │
│ │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                         Error Recovery Strategies                           │ │
│ │                                                                             │ │
│ │  ┌─────────────────────────────────────────────────────────────────────┐   │ │
│ │  │                         Retry Logic                                 │   │ │
│ │  │                                                                     │   │ │
│ │  │  Network Errors:                                                    │   │ │
│ │  │    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │   │ │
│ │  │    │ Try #1      │───▶│ Try #2      │───▶│ Try #3      │          │   │ │
│ │  │    │ (immediate) │    │ (backoff)   │    │ (backoff²)  │          │   │ │
│ │  │    └─────────────┘    └─────────────┘    └─────────────┘          │   │ │
│ │  │                                                │                   │   │ │
│ │  │  Build Errors:                                 ▼                   │   │ │
│ │  │    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │   │ │
│ │  │    │ Clean build │───▶│ Retry with  │───▶│ Skip gem /  │          │   │ │
│ │  │    │ environment │    │ verbose     │    │ report error│          │   │ │
│ │  │    └─────────────┘    └─────────────┘    └─────────────┘          │   │ │
│ │  └─────────────────────────────────────────────────────────────────────┘   │ │
│ │                                                                             │ │
│ │  ┌─────────────────────────────────────────────────────────────────────┐   │ │
│ │  │                      Fallback Mechanisms                           │   │ │
│ │  │                                                                     │   │ │
│ │  │  Resolution Conflicts:                                              │   │ │
│ │  │    1. Try conservative update                                       │   │ │
│ │  │    2. Suggest dependency relaxation                                 │   │ │
│ │  │    3. Report detailed conflict information                          │   │ │
│ │  │                                                                     │   │ │
│ │  │  Source Unavailable:                                                │   │ │
│ │  │    1. Try alternative sources                                       │   │ │
│ │  │    2. Use cached versions                                           │   │ │
│ │  │    3. Suggest offline mode                                          │   │ │
│ │  │                                                                     │   │ │
│ │  │  Build Failures:                                                    │   │ │
│ │  │    1. Try precompiled versions                                      │   │ │
│ │  │    2. Skip optional dependencies                                    │   │ │
│ │  │    3. Provide detailed build logs                                   │   │ │
│ │  └─────────────────────────────────────────────────────────────────────┘   │ │
│ │                                                                             │ │
│ │  ┌─────────────────────────────────────────────────────────────────────┐   │ │
│ │  │                    User Experience                                  │   │ │
│ │  │                                                                     │   │ │
│ │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐ │   │ │
│ │  │  │ Progress        │  │ Detailed        │  │ Actionable          │ │   │ │
│ │  │  │ Indicators      │  │ Error Messages  │  │ Suggestions         │ │   │ │
│ │  │  │                 │  │                 │  │                     │ │   │ │
│ │  │  │ - Spinner       │  │ - Root cause    │  │ - Fix commands      │ │   │ │
│ │  │  │ - Progress bars │  │ - Context info  │  │ - Alternative paths │ │   │ │
│ │  │  │ - Step counter  │  │ - Stack traces  │  │ - Documentation     │ │   │ │
│ │  │  └─────────────────┘  └─────────────────┘  └─────────────────────┘ │   │ │
│ │  └─────────────────────────────────────────────────────────────────────┘   │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Concurrency Model

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Concurrency Architecture                             │
│                                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                        Thread Pool Management                              │ │
│ │                                                                             │ │
│ │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│ │  │ Resolution      │  │ Download        │  │      Build Pool            │ │ │
│ │  │ Pool            │  │ Pool            │  │                             │ │ │
│ │  │                 │  │                 │  │                             │ │ │
│ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────────────────┐ │ │ │
│ │  │ │Single Thread│ │  │ │Parallel HTTP│ │  │ │   CPU-bound Builds      │ │ │ │
│ │  │ │(Dependency  │ │  │ │  Requests   │ │  │ │                         │ │ │ │
│ │  │ │ Resolution) │ │  │ └─────────────┘ │  │ │ - Native extensions     │ │ │ │
│ │  │ └─────────────┘ │  │ ┌─────────────┐ │  │ │ - Compilation           │ │ │ │
│ │  │                 │  │ │Concurrent   │ │  │ │ - FFI bindings         │ │ │ │
│ │  │                 │  │ │Git Clones   │ │  │ └─────────────────────────┘ │ │ │
│ │  │                 │  │ └─────────────┘ │  │                             │ │ │
│ │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                         Shared State Synchronization                       │ │
│ │                                                                             │ │
│ │              ┌─────────────────────────────────────────────┐                │ │
│ │              │           BundlerContext (Arc)             │                │ │
│ │              └─────────────────┬───────────────────────────┘                │ │
│ │                                │                                            │ │
│ │  ┌─────────────────────────────┼─────────────────────────────┐              │ │
│ │  │                             │                             │              │ │
│ │  ▼                             ▼                             ▼              │ │
│ │ ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────────────────┐ │ │
│ │ │ Cache           │   │ Config          │   │ Sources                     │ │ │
│ │ │ (RwLock)        │   │ (Immutable)     │   │ (Arc<Vec<Source>>)         │ │ │
│ │ │                 │   │                 │   │                             │ │ │
│ │ │ ┌─────────────┐ │   │ ┌─────────────┐ │   │ ┌─────────────────────────┐ │ │ │
│ │ │ │ Read-heavy  │ │   │ │ Shared      │ │   │ │ Concurrent Access       │ │ │ │
│ │ │ │ Operations  │ │   │ │ Read Access │ │   │ │                         │ │ │ │
│ │ │ │             │ │   │ │             │ │   │ │ - Thread-safe sources   │ │ │ │
│ │ │ │ - Spec      │ │   │ │ - Platform  │ │   │ │ - Load balancing        │ │ │ │
│ │ │ │   lookups   │ │   │ │   info      │ │   │ │ - Failover handling     │ │ │ │
│ │ │ │ - Dependency│ │   │ │ - Auth      │ │   │ │                         │ │ │ │
│ │ │ │   queries   │ │   │ │   tokens    │ │   │ │                         │ │ │ │
│ │ │ └─────────────┘ │   │ └─────────────┘ │   │ └─────────────────────────┘ │ │ │
│ │ │                 │   │                 │   │                             │ │ │
│ │ │ ┌─────────────┐ │   │                 │   │                             │ │ │
│ │ │ │ Write       │ │   │                 │   │                             │ │ │
│ │ │ │ Operations  │ │   │                 │   │                             │ │ │
│ │ │ │             │ │   │                 │   │                             │ │ │
│ │ │ │ - Cache     │ │   │                 │   │                             │ │ │
│ │ │ │   updates   │ │   │                 │   │                             │ │ │
│ │ │ │ - File      │ │   │                 │   │                             │ │ │
│ │ │ │   storage   │ │   │                 │   │                             │ │ │
│ │ │ └─────────────┘ │   │                 │   │                             │ │ │
│ │ └─────────────────┘   └─────────────────┘   └─────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                         Async Operation Flow                                │ │
│ │                                                                             │ │
│ │     ┌─────────────┐        ┌─────────────┐        ┌─────────────────────┐   │ │
│ │     │  Resolver   │        │ Downloader  │        │    Build System     │   │ │
│ │     │             │        │             │        │                     │   │ │
│ │     │      ┌──────┴─────┐  │      ┌──────┴─────┐  │      ┌──────────────┤   │ │
│ │     │      │ Dependency │  │      │   HTTP     │  │      │   Compile    │   │ │
│ │     │      │ Resolution │  │      │  Requests  │  │      │  Extensions  │   │ │
│ │     │      │   (Sync)   │  │      │   (Async)  │  │      │   (Async)    │   │ │
│ │     │      └──────┬─────┘  │      └──────┬─────┘  │      └──────────────┤   │ │
│ │     │             │        │             │        │                     │   │ │
│ │     │      ┌──────▼─────┐  │      ┌──────▼─────┐  │      ┌──────────────┤   │ │
│ │     │      │   Result   │  │      │   Files    │  │      │   Binaries   │   │ │
│ │     │      │ Production │  │      │ Available  │  │      │   Available  │   │ │
│ │     │      └──────┬─────┘  │      └──────┬─────┘  │      └──────────────┤   │ │
│ │     └─────────────┘        └─────────────┘        └─────────────────────┘   │ │
│ │                                   │                         │               │ │
│ │                                   │                         │               │ │
│ │     ┌─────────────────────────────┼─────────────────────────┼─────────────┐ │ │
│ │     │                Coordination & Synchronization          │             │ │ │
│ │     │                                                        │             │ │ │
│ │     │  ┌─────────────────┐   ┌─────────────────┐   ┌────────▼───────────┐ │ │ │
│ │     │  │ Channel-based   │   │ Future/Promise  │   │ Barrier            │ │ │ │
│ │     │  │ Communication   │   │ Coordination    │   │ Synchronization    │ │ │ │
│ │     │  │                 │   │                 │   │                    │ │ │ │
│ │     │  │ - Work queues   │   │ - Async/await   │   │ - Wait for all     │ │ │ │
│ │     │  │ - Progress      │   │ - Task spawning │   │   downloads        │ │ │ │
│ │     │  │   reporting     │   │ - Error         │   │ - Wait for all     │ │ │ │
│ │     │  │ - Result        │   │   propagation   │   │   builds           │ │ │ │
│ │     │  │   collection    │   │                 │   │                    │ │ │ │
│ │     │  └─────────────────┘   └─────────────────┘   └────────────────────┘ │ │ │
│ │     └─────────────────────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

These diagrams illustrate the comprehensive architecture of the Rust Ruby bundler, showing how components interact, share state, handle errors, and manage concurrent operations efficiently.